# Подробное описание изменений в проекте для лабораторной работы №4

## 1. Модель Product (src/models.py)

### Добавлено:
- Поле `stock_quantity: Mapped[int] = mapped_column(nullable=False, default=0)` для хранения количества товара на складе

### Изменено:
- Структура заказов - теперь заказ может содержать несколько продуктов через промежуточную таблицу `order_items`

### Создана промежуточная таблица:
```python
order_items = sa.Table(
    'order_items',
    Base.metadata,
    sa.Column('order_id', sa.ForeignKey('orders.id', ondelete='CASCADE'), primary_key=True),
    sa.Column('product_id', sa.ForeignKey('products.id', ondelete='CASCADE'), primary_key=True),
    sa.Column('quantity', sa.Integer, nullable=False, default=1),
    sa.Column('price_at_order', sa.Float, nullable=False)  # цена продукта на момент заказа
)
```

### Изменения в модели Order:
- Удалены поля `product_id` и `quantity` из основной таблицы заказов
- Добавлена связь `products: Mapped[List["Product"]] = relationship("Product", secondary="order_items", back_populates="orders")`
- Поле `total_price` теперь рассчитывается как сумма всех товаров в заказе

## 2. Репозитории

### Создан app/repositories/product_repository.py:
- Методы: `get_by_id`, `get_by_filter`, `create`, `update`, `delete`
- Поддержка фильтрации по названию, диапазону цен
- Пагинация

### Создан app/repositories/order_repository.py:
- Методы: `get_by_id`, `get_by_filter`, `create`, `update`, `delete`
- Поддержка создания заказа с несколькими продуктами
- Автоматическое управление остатками на складе при создании заказа

### Обновлен app/repositories/user_repository.py:
- Добавлены тесты для методов удаления и получения списка пользователей

## 3. Схемы Pydantic (app/schemas/)

### Создан app/schemas/product.py:
- `ProductBase`, `ProductCreate`, `ProductUpdate`, `ProductResponse`
- Поддержка всех необходимых полей включая `stock_quantity`

### Создан app/schemas/order.py:
- `OrderItemBase`, `OrderItemResponse` - для представления элементов заказа
- `OrderBase`, `OrderCreate`, `OrderUpdate`, `OrderResponse` - для представления заказа с несколькими продуктами

### Обновлен app/schemas/user.py:
- Добавлены недостающие методы и обновления

## 4. Сервисы (app/services/)

### Создан app/services/product_service.py:
- Методы бизнес-логики для работы с продуктами
- Обертки для вызовов репозитория

### Создан app/services/order_service.py:
- Методы бизнес-логики для работы с заказами
- Проверка наличия товаров на складе при создании заказа
- Управление остатками при создании заказа

### Обновлен app/services/user_service.py:
- Добавлены недостающие методы

## 5. Контроллеры (app/controllers/)

### Создан app/controllers/product_controller.py:
- CRUD эндпоинты для продуктов
- Поддержка пагинации и фильтрации

### Создан app/controllers/order_controller.py:
- CRUD эндпоинты для заказов
- Поддержка пагинации и фильтрации

### Обновлен app/controllers/user_controller.py:
- Обновлены методы для использования `model_validate` вместо `from_orm`

## 6. Обновлен app/main.py:
- Добавлены импорты новых контроллеров, репозиториев и сервисов
- Добавлены провайдеры зависимостей для новых компонентов
- Включены новые контроллеры в `route_handlers`

## 7. Тесты (tests/)

### Создан tests/conftest.py:
- Фикстуры для тестовой базы данных
- Фикстуры для репозиториев, сессии и клиента
- Использование отдельной тестовой базы данных SQLite

### Создан tests/test_user_repository.py:
- Тесты для всех методов репозитория пользователей
- Включая создание, получение по ID, фильтрацию, обновление, удаление и получение списка

### Создан tests/test_product_repository.py:
- Тесты для всех методов репозитория продуктов
- Включая создание, получение по ID, фильтрацию, обновление и удаление

### Создан tests/test_order_repository.py:
- Тесты для всех методов репозитория заказов
- Включая создание заказа с несколькими продуктами

### Создан tests/test_order_service.py:
- Тесты для сервиса заказов с использованием моков
- Проверка сценариев успешного создания заказа и ошибки при недостатке товара

### Создан tests/test_api.py:
- Тесты для API-эндпоинтов
- Проверка корректности работы эндпоинтов получения пользователей, продуктов и заказов

## 8. Конфигурация (pyproject.toml)

### Добавлены зависимости для тестирования:
- `pytest`, `pytest-asyncio`, `polyfactory`, `pytest-cov`
- Настройки pytest: testpaths, asyncio_mode, addopts

## 9. Миграции (migrations/)

### Создана новая миграция 2fd469833155_добавлено_поле_stock_quantity_в_.py:
- Добавление поля stock_quantity в таблицу products
- Создание промежуточной таблицы order_items
- Удаление полей product_id и quantity из таблицы orders

### Обновлена миграция 29494df1622a_правки_поля_description_в_user.py:
- Исправление дублирования добавления поля description
- Удаление лишнего добавления поля, которое уже добавляется в предыдущей миграции

## 10. Дополнительные файлы

### Создан QUESTIONS_ANSWERS.md:
- Ответы на все вопросы из задания лабораторной работы
- Примеры тестов для граничных случаев
- Объяснение подходов к тестированию различных аспектов приложения

## Основные архитектурные изменения:

1. **Поддержка заказов с несколькими продуктами**:
   - Введена промежуточная таблица `order_items` для связи "многие ко многим" между заказами и продуктами
   - Каждый заказ теперь может содержать несколько разных продуктов в разных количествах

2. **Управление остатками**:
   - При создании заказа автоматически уменьшается количество товара на складе
   - Проверка наличия достаточного количества товара перед созданием заказа

3. **Полная покрытие тестами**:
   - Unit-тесты для репозиториев
   - Тесты сервисного слоя с использованием моков
   - Интеграционные тесты API
   - Использование фикстур для изоляции тестов

4. **Расширение функциональности**:
   - Добавлены CRUD операции для продуктов и заказов
   - Поддержка фильтрации и пагинации для всех сущностей
   - Проверка бизнес-логики в сервисном слое